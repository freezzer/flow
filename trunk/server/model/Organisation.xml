<?xml version="1.0"?>
<!DOCTYPE define SYSTEM "model.dtd">

<define >

    <model package="bom">

        <bean name="Organisation" persistent="true">
            <field name="name"/>
            <field name="adresse" type="Adresse" create="true"/>
            <collection name="personen" type="Person" create="1"/>
            <collection name="notizen" create="1">
                <bean name="Notiz">
                    <field name="erfasser"   type="String"/>
                    <field name="datum" type="date"/>
                    <field name="kontaktperson" type="Person" reference="true"/>
                    <field name="text"/>
                    <field name="assignedTo" type="Person" reference="true"/>
                    <field name="todo"/>
                </bean>
            </collection>
        </bean>

    </model>

    <permission package="permission" name="Organisation">

        <view package="view.organisation">

            <lister name="OrganisationenLister" label="Uebersicht Organisationen" type="Organisation">
                <command use="LoadTableCommand" icon="refresh" label="Uebersicht Organisationen neu laden"/>
                <command use="OpenEditorCommand" editor="OrganisationenEditor" label="Organisation bearbeiten" icon="edit" default="true"/>
                <command use="DeleteBoCommand" label="Organisation loeschen" icon="delete"/>
                <command use="OpenEditorCommand_New" editor="OrganisationenEditor" label="neue Organisation anlegen" />

                <column path="name"    label="Name"         searchable="true"/>
                <column path="adresse.land" label="Land" searchable="true"/>
                <column path="adresse.ort" label="Ort"   searchable="true"/>
                <!--<column path="adressen.Adresse[1]/ort" label="1. Adresse" searchable="true"/>-->
            </lister>

            <tree_editor name="OrganisationenEditor" label="Orga {name} " type="Organisation">
                <tree_node label="Organisation {name}" path="." type="Organisation" icon="building" open="true" panel="default">
                    <tree_node label="Adresse {ort}" path="adresse" icon="form" open="true" type="Adresse"  panel="AdressePanel" />
                    <tree_node label="Personen" path="personen" icon="table" open="true" type="Person"  lister="PersonLister">
                        <command use="CreateNodeCommand" label="neue Person" icon="new"/>
                        <tree_node label="Kontakt {nachname}" path="personen" icon="user" open="true" type="Person"
                                   panel="default">
                            <command use="CreateNodeCommand" label="neue Adresse" icon="new"/>
                            <command use="CopyNodeCommand" label="Adresse kopieren" icon="copy"/>
                            <command use="DeleteNodeCommand" label="Adresse loeschen" icon="delete"/>
                        </tree_node>
                    </tree_node>
                    <tree_node label="Notizen" path="notizen" icon="table" open="true" type="Notiz"  lister="default">
                        <command use="CreateNodeCommand" label="neue Notiz" icon="new"/>
                        <tree_node label="Notiz {datum}" path="notizen" icon="dock" open="true" type="Notiz"
                                   panel="NotizPanel">
                            <command use="CreateNodeCommand" label="neue Notiz" icon="new"/>
                            <command use="CopyNodeCommand" label="Notiz kopieren" icon="copy"/>
                            <command use="DeleteNodeCommand" label="Notiz loeschen" icon="delete"/>
                        </tree_node>
                    </tree_node>
                </tree_node>

                <command use="SaveBoCommand" label="Organisation speichern" icon="save" event="pre.save"/>
                <command use="LoadBoCommand" label="Organisation laden" icon="refresh"/>
                <command use="DeleteBoCommand" label="Organisation loeschen" icon="delete"/>
            </tree_editor>

            <panel name="NotizPanel" label="Notiz" border="true" x="25" y="25" w="595" h="360" path="." >
                <input x="9" y="22" w="205" labelwidth="80" h="25" label="erfasst" path="datum" type="date" />
                <input x="301" y="18" w="280" labelwidth="55" label="Erfasser" path="erfasser" type="string" default="{system.user.name}"/>
                <input x="8" y="63" w="575" labelwidth="80" h="115" label="Notiz" path="text" type="area" />
                <lookup x="9" y="184" w="354" labelwidth="80" label="Kontakt" path="kontaktperson" type="Person" guirep="nachname" editor="PersonEditor">
                    <lister use="PersonLister" type="Person" >
                        <provider type="Person" use="ModelDataProvider" path="personen"/>
                    </lister>
                </lookup>

                <lookup x="8" y="344" w="354" labelwidth="80" label="zugewiesen" path="assignedTo" type="Person" guirep="nachname" editor="PersonEditor" lister="PersonLister"/>
                <input x="9" y="235" w="575" labelwidth="80" h="105" label="ToDo" path="todo" type="area" />
            </panel>
        </view>

    </permission>

    <logic package="organisation">

        <event_consumer name="PreSaveOrgaConsumer" type="Organisation" events="pre.save"/>
        <event_consumer name="PostSaveOrgaConsumer" type="Organisation" events="post.save"/>


        <rules name="OrganisationRules" events="pre.save" type="Organisation">
            <rule label="Name der Organisation" path="name" pattern="an" maxlength="30" mandatory="true"/>
            <rules use="AdresseRules" path="adresse" />
            <rules use="PersonRules" path="personen" />
            <rules name="NotizenRules" path="notizen" >
                <rule label="Kontaktperson" path="kontaktperson" mandatory="true" />
                <rule label="Erfasser" path="erfasser" mandatory="true" />
                <rule label="Datum" path="datum" mandatory="true" />
                <rule label="Text" path="text" mandatory="true" maxlength="255"/>
                <rule label="ToDo" path="todo" maxlength="255" />
            </rules>
        </rules>
    </logic>


</define>




